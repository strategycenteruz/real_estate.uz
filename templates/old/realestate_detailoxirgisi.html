{% extends 'base.html' %}
{% load static humanize %}
{% block content %}
<div class="container py-4">

  <a href="{% url 'home' %}" class="btn btn-sm btn-outline-dark mb-3">â† ĞĞ°Ğ·Ğ°Ğ´</a>

  <div class="row g-4">
    <div class="col-lg-8">

      <div id="carouselImages" class="carousel slide" data-bs-ride="carousel">
  <div class="carousel-inner">
    {% for image in realestate.images.all %}
      <div class="carousel-item {% if forloop.first %}active{% endif %}">
        <img src="{{ image.image.url }}" class="d-block w-100 lightbox-trigger"
             alt="Ğ¤Ğ¾Ñ‚Ğ¾ {{ forloop.counter }}"
             data-index="{{ forloop.counter0 }}"
             data-img="{{ image.image.url }}"
             style="height: 450px; object-fit: cover; cursor: zoom-in;"
             data-bs-toggle="modal" data-bs-target="#lightboxModal">
      </div>
    {% endfor %}
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carouselImages" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carouselImages" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>



     <!-- ğŸ–¼ Lightbox Modal -->
      <div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content bg-dark border-0 position-relative">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3"
                    data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body p-0 d-flex justify-content-center align-items-center position-relative">
              <button class="btn btn-light position-absolute start-0 ms-3 z-3" id="prevImage">â®</button>
              <img id="lightboxImage" src="" class="img-fluid" style="max-height: 90vh; object-fit: contain;">
              <button class="btn btn-light position-absolute end-0 me-3 z-3" id="nextImage">â¯</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ğŸ“‹ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ -->
      <div class="mt-3 d-flex align-items-center justify-content-between">
        <h4 class="mb-0">{{ realestate.title }}</h4>
        <span class="badge {% if realestate.status == 'active' %}bg-danger{% else %}bg-secondary{% endif %}">
          {% if realestate.status == 'active' %}ğŸ”¥ Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾{% else %}âœ… ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾{% endif %}
        </span>
      </div>
      <h5 class="text-primary mt-2">{{ realestate.price_usd|floatformat:0|intcomma }} $</h5>
      <p class="text-muted mb-4">{{ realestate.location }}</p>

      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ -->
      <ul class="nav nav-tabs mb-3" id="tabContent" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info">â„¹ï¸ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#desc">ğŸ“ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</button>
        </li>
        {% if realestate.video %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#video">ğŸ¬ Ğ’Ğ¸Ğ´ĞµĞ¾</button>
        </li>
        {% endif %}
        {% if realestate.latitude and realestate.longitude %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#map">ğŸ—º ĞšĞ°Ñ€Ñ‚Ğ°</button>
        </li>
        {% endif %}
      </ul>

      <div class="tab-content">
        <!-- â„¹ï¸ Info -->
        <div class="tab-pane fade show active" id="info">
          <div class="row">
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">ğŸ“ <strong>ĞĞ´Ñ€ĞµÑ:</strong> {{ realestate.location }}</li>
                <li class="list-group-item">ğŸ“ <strong>ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ:</strong> {{ realestate.area }} Ğ¼Â²</li>
                <li class="list-group-item">ğŸ¢ <strong>Ğ¢Ğ¸Ğ¿:</strong> {{ realestate.get_type_display }}</li>
                <li class="list-group-item">ğŸ§± <strong>Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:</strong> {{ realestate.get_condition_display }}</li>
                <li class="list-group-item">ğŸ›‹ <strong>ĞœĞµĞ±ĞµĞ»ÑŒ:</strong> {{ realestate.furniture|yesno:"Ğ•ÑÑ‚ÑŒ,ĞĞµÑ‚" }}</li>
                <li class="list-group-item">ğŸ—“ <strong>Ğ”Ğ°Ñ‚Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:</strong> {{ realestate.created_at|date:"d.m.Y" }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">ğŸšª <strong>ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹:</strong> {{ realestate.rooms }}</li>
                <li class="list-group-item">ğŸ§± <strong>Ğ­Ñ‚Ğ°Ğ¶:</strong> {{ realestate.floor }}/{{ realestate.total_floors }}</li>
                <li class="list-group-item">ğŸ“¶ <strong>Ğ¢ĞµÑ€Ñ€Ğ°ÑĞ°:</strong> {{ realestate.has_terrace|yesno:"Ğ•ÑÑ‚ÑŒ,ĞĞµÑ‚" }}</li>
                <li class="list-group-item">ğŸ§¾ <strong>ĞšĞ°Ğ´Ğ°ÑÑ‚Ñ€:</strong> {{ realestate.cadastral|yesno:"Ğ•ÑÑ‚ÑŒ,ĞĞµÑ‚" }}</li>
                <li class="list-group-item">ğŸ“ <strong>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:</strong> <a href="tel:{{ realestate.phone }}">{{ realestate.phone }}</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- ğŸ“ Description -->
        <div class="tab-pane fade" id="desc">
          <div class="card border-0 mt-3 p-3 bg-light rounded">
            <p class="text-muted">{{ realestate.description }}</p>
          </div>
        </div>

        <!-- ğŸ¬ Video -->
        {% if realestate.video %}
        <div class="tab-pane fade" id="video">
          <div class="mt-3">
            <video src="{{ realestate.video.url }}" controls muted autoplay loop
              style="width: 250px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            </video>
          </div>
        </div>
        {% endif %}


         <!-- ğŸ—º Map Tab -->
          {% if realestate.latitude and realestate.longitude %}
         <div class="tab-pane fade" id="map">
            <div class="mt-3">
              <h4>ğŸ“ ĞĞ° ĞºĞ°Ñ€Ñ‚Ğµ</h4>
              <div id="yandex-map" style="height: 400px; width: 100%; border-radius: 10px; overflow: hidden;"></div>

            </div>
          </div>
          {% endif %}

          <li class="list-group-item">ğŸ“ <strong>ĞĞ´Ñ€ĞµÑ:</strong> {{ realestate.address }}</li>
      </div>

      <!-- ğŸ” ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ -->
      {% if related_realestates %}
      <div class="mt-5">
        <h5>ğŸ” ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ</h5>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          {% for item in related_realestates %}
          <div class="col">
            <a href="{% url 'realestate_detail' item.pk %}" class="text-decoration-none text-dark">
              <div class="card shadow-sm h-100">
                {% if item.images.first %}
                <img src="{{ item.images.first.image.url }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                  <h6 class="card-title">{{ item.title }}</h6>
                  <p class="text-primary fw-bold">{{ item.price_usd|floatformat:0|intcomma }} $</p>
                  <p class="text-muted small">{{ item.location }}</p>
                </div>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    <!-- ğŸ‘‰ Kontak panel -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 p-4 position-sticky" style="top: 80px;">
        <h6 class="text-muted mb-3">ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹</h6>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-info" href="tel:{{ realestate.phone }}">ğŸ“ ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</a>
          <a class="btn btn-outline-success" href="https://t.me/share/url?url=tel:{{ realestate.phone|urlencode }}" target="_blank">ğŸ’¬ Telegram</a>
          <a class="btn btn-outline-danger" href="{% url 'toggle_favorite' realestate.pk %}">
            {% if realestate.is_favorite %}â¤ï¸ Ğ’ Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼{% else %}ğŸ¤ Ğ’ Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ{% endif %}
          </a>
        </div>
      </div>
    </div>
    <!-- ğŸ—º Map Tab -->
  </div>


</div>

{% if realestate.latitude and realestate.longitude %}
<script>
  console.log("Koordinatalar:", {{ realestate.latitude }}, {{ realestate.longitude }});
</script>

<script src="https://api-maps.yandex.ru/2.1/?apikey=3e0c91bd-d2cb-4581-9294&lang=ru_RU"></script>
<script>
  let mapInited = false;

  function initMap() {
    if (mapInited) return;
    mapInited = true;

    ymaps.ready(function () {
      const lat = {{ realestate.latitude }};
      const lon = {{ realestate.longitude }};
      const address = "{{ realestate.location|escapejs }}";

      const myMap = new ymaps.Map("yandex-map", {
        center: [lat, lon],
        zoom: 16,
        controls: ['zoomControl', 'fullscreenControl']
      });

      const myPlacemark = new ymaps.Placemark([lat, lon], {
        balloonContent: address
      }, {
        preset: 'islands#redDotIcon'
      });

      myMap.geoObjects.add(myPlacemark);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const mapTabBtn = document.querySelector('[data-bs-target="#map"]');

    if (mapTabBtn) {
      mapTabBtn.addEventListener("shown.bs.tab", function () {
        initMap();
      });

      // Agar sahifa #map bilan ochilgan boâ€˜lsa
      if (window.location.hash === "#map") {
        initMap();
      }
    }
  });
</script>
{% endif %}



{% endblock %}
