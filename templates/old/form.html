{% extends 'base.html' %}
{% load static %}
{% block title %}Добавить объявление{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Добавить объявление</h2>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="row">
      <!-- Left side form fields -->
      <div class="col-md-8">
        <div class="mb-3">
          {{ form.type.label_tag }} {{ form.type }}
        </div>
        <div class="mb-3">
          {{ form.status.label_tag }} {{ form.status }}
        </div>
        <div class="mb-3">
          {{ form.district.label_tag }} {{ form.district }}
        </div>
        <div class="mb-3">
          {{ form.address.label_tag }} {{ form.address }}
        </div>
        <div class="mb-3">
          {{ form.orientir.label_tag }} {{ form.orientir }}
        </div>
        <div class="mb-3">
          {{ form.rooms.label_tag }} {{ form.rooms }}
        </div>
        <div class="mb-3">
          {{ form.floor.label_tag }} {{ form.floor }}
        </div>
        <div class="mb-3">
          {{ form.total_floors.label_tag }} {{ form.total_floors }}
        </div>
        <div class="mb-3">
          {{ form.area.label_tag }} {{ form.area }}
        </div>
        <div class="mb-3">
          {{ form.condition.label_tag }} {{ form.condition }}
        </div>
        <div class="mb-3">
          {{ form.balcony_size.label_tag }} {{ form.balcony_size }}
        </div>
        <div class="mb-3">
          {{ form.price_usd.label_tag }} {{ form.price_usd }}
        </div>
        <div class="mb-3">
          {{ form.phone.label_tag }} {{ form.phone }}
        </div>

        <!-- Map -->
        <div class="mb-4">
          <label class="form-label">Отметьте точку на карте</label>
          <div id="map" style="width: 100%; height: 400px;"></div>

        </div>

        <button type="submit" class="btn btn-primary">Сохранить</button>
      </div>

      <!-- Right side uploads -->
      <div class="col-md-4">
        <div class="mb-3">
          <label for="id_images" class="form-label">Фотографии (до 10)</label>
          <input type="file" name="images" multiple accept="image/*" class="form-control" id="id_images">
        </div>
        <div class="mb-3">
          <label for="id_video" class="form-label">Видео (до 1 минуты)</label>
          <input type="file" name="video" accept="video/mp4" class="form-control" id="id_video">
        </div>
      </div>
    </div>
  </form>
</div>
<!-- Yandex Maps API -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=3e0c91bd-d2cb-4581-9294-6ce44e90b5f3" type="text/javascript"></script>

<script>
  ymaps.ready(function () {
    // Изначальные координаты – центр Ташкента
    var initCoords = [41.311081, 69.240562];
    // Если форма редактируется и уже есть координаты, используем их
    var latField = document.getElementById("id_latitude");
    var lonField = document.getElementById("id_longitude");
    var currentLat = latField.value || initCoords[0];
    var currentLon = lonField.value || initCoords[1];

    var myMap = new ymaps.Map("map", {
      center: [currentLat, currentLon],
      zoom: 12,
      controls: ['zoomControl', 'fullscreenControl']
    });

    var placemark = new ymaps.Placemark([currentLat, currentLon], {}, { draggable: true });
    myMap.geoObjects.add(placemark);

    // При перетаскивании метки обновляем координаты
    placemark.events.add('dragend', function (e) {
      var coords = placemark.geometry.getCoordinates();
      latField.value = coords[0];
      lonField.value = coords[1];
    });

    // При клике по карте перемещаем метку и обновляем координаты
    myMap.events.add('click', function (e) {
      var coords = e.get('coords');
      placemark.geometry.setCoordinates(coords);
      latField.value = coords[0];
      lonField.value = coords[1];
    });
  });
</script>
{% endblock %}